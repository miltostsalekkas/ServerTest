<html>

<head>
  <title>Social Mic</title>
  <meta name="viewport" content="user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1,width=device-width">
  <style>
    body {
      padding: 0;
      margin: 0;
      cursor: pointer;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"></script> <!-- P5 js Library -->

  <script src="/socket.io/socket.io.js"></script> <!-- Socket IO Library -->

  <!--
      We use unpkg instead of cdnjs as its recommended by tone.js docs
    -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/addons/p5.sound.js"></script> <!-- P5 sound Js -->

  <!-- <script src="sketch.js"></script> -->
  <script>


    var mic, fft;
    var sensibility;

    var LocalData;

    var bgcolor;

    var tilecolor;

    var heightAux2 = 0;
    var PixelEntry;

    var columnsNo = 0;
    var rowsNo = 0;

    var GridInit = true;

    var Id;

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
      // sendGrid(columnsNo, rowsNo);
    }

    function setup() {
      createCanvas(windowWidth, windowHeight);
      bgcolor = color(255);

      socket = io();

      sensibility = 4;



      getAudioContext().suspend();
      mic = new p5.AudioIn();
      mic.start();
      fft = new p5.FFT();
      fft.setInput(mic);

      Id = socket.id;

      socket.on('Public',
        // When we receive data
        function (data) {
          LocalData = data;

        }
      );



    }

    function draw() {


      background(246, 246, 246);

      var RightMargin = 250;
      TileSize = 70;
      var FrameMargin = 20;
      columnsNo = Math.floor((windowWidth - RightMargin) / TileSize);
      rowsNo = Math.floor((windowHeight - 2 * FrameMargin) / TileSize);


      if (LocalData != null) {


        var Microphones = [];
        var Positions = [{ x: 1, y: 2 }];
        var Colors = [];

        for (var i = 0; i < LocalData.length; i++) {
          Microphones.push(Object.values(LocalData[i])[0].Volume);
          Positions.push(Object.values(LocalData[i])[0].position);
          if (Object.keys(LocalData[i])[0] === socket.id) {
            bgcolor = (Object.values(LocalData[i])[0].color.hex);
            
          }
          Colors.push((Object.values(LocalData[i])[0].color.hex));
        }

        if (GridInit && socket.id) {

          sendGrid(columnsNo, rowsNo);
          GridInit = false;
        }
        var margin = 0.9;


        push();


        for (var x = 0; x < columnsNo; x++) {
          for (var y = 0; y < rowsNo; y++) {
            for (var i = 0; i < LocalData.length; i++) {
              noStroke();
              fill(210, 210, 210);

              square(FrameMargin + x * TileSize, FrameMargin + y * TileSize, TileSize * margin);
              push();
              fill(color(Colors[i]).levels[0],color(Colors[i]).levels[1],color(Colors[i]).levels[2], Aux(Microphones[i]));
              square(FrameMargin + Positions[i].x * TileSize, FrameMargin + Positions[i].y * TileSize, TileSize * margin);
              pop();
            }
          }
        }
      }

      push();
      noStroke();
      fill(246, 246, 246);

      rect(windowWidth - RightMargin, 0, windowWidth, windowHeight);
      pop();

      push();

      noStroke();
      fill(bgcolor);
      var PersonalTileSize = 180;
      square(windowWidth - RightMargin + (RightMargin - PersonalTileSize) / 2, FrameMargin, PersonalTileSize);
      pop();






      noStroke();
      fill(255);
      textSize(20);



      var volume = mic.getLevel();
      if (volume > 0.01) {
        sendmouse(volume);

      }




      var heightAux1 = map(volume * sensibility, 0, 1, 50, 400);
      function Aux(volume) {
        var heightAux = map(volume * sensibility, 0.1, 1, 0, 300);
        return heightAux;
      }

      noFill();
      strokeWeight(heightAux1 / 8);
      stroke(246, 246, 246);
      ellipseMode(CENTER);
      ellipse(windowWidth - RightMargin + (RightMargin - PersonalTileSize) / 2 + PersonalTileSize / 2, PersonalTileSize / 2 + FrameMargin, 100 + heightAux1 / 8, 100 + heightAux1 / 8);

    }

    function mouseMoved() {
      userStartAudio();
    }

    // // Function for sending to the socket
    function sendmouse(volume) {
      // We are sending!
      // console.log("Send MicVolume: " + volume);

      var data = {
        [socket.id]: { Volume: volume, Grid: { x: columnsNo, y: rowsNo } }
      };


      socket.emit('mic', data);
    }
    function sendGrid(columnsNo, rowsNo) {


      var data = {
        [socket.id]: { x: columnsNo, y: rowsNo }
      };
  
      socket.emit('grid', data);
    }

  </script>
</head>

<body></body>

</html>